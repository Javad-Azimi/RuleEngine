@using Newtonsoft.Json

<div class="mapping-editor">
    <div class="row">
        <div class="col-md-6">
            <h5>Mapping Definition</h5>
            <div class="form-group">
                <label>JSON Template:</label>
                <textarea class="form-control font-monospace" 
                          rows="15" 
                          @bind="MappingJson" 
                          @oninput="OnMappingChanged"
                          placeholder="Enter your mapping JSON template here..."></textarea>
            </div>
            
            <div class="mt-3">
                <h6>Available Functions:</h6>
                <ul class="list-unstyled small">
                    <li><code>{{`toString(value)`}}</code> - Convert to string</li>
                    <li><code>{{`toNumber(value)`}}</code> - Convert to number</li>
                    <li><code>{{`concat(a,b,...)`}}</code> - Concatenate values</li>
                    <li><code>{{`dateNow()`}}</code> - Current date/time</li>
                    <li><code>{{`formatDate(date, format)`}}</code> - Format date</li>
                    <li><code>{{`if(condition, trueValue, falseValue)`}}</code> - Conditional</li>
                </ul>
            </div>
        </div>
        
        <div class="col-md-6">
            <h5>Preview</h5>
            <div class="form-group">
                <label>Sample Input Data:</label>
                <textarea class="form-control font-monospace" 
                          rows="8" 
                          @bind="SampleInput" 
                          @oninput="OnSampleInputChanged"
                          placeholder="Enter sample JSON data to test mapping..."></textarea>
            </div>
            
            <div class="form-group mt-3">
                <label>Mapped Output:</label>
                <div class="border p-2 bg-light" style="min-height: 200px;">
                    @if (!string.IsNullOrEmpty(PreviewOutput))
                    {
                        <pre class="mb-0"><code>@PreviewOutput</code></pre>
                    }
                    else
                    {
                        <small class="text-muted">Preview will appear here...</small>
                    }
                </div>
            </div>
            
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger mt-2">
                    <small>@ErrorMessage</small>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public string MappingJson { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> MappingJsonChanged { get; set; }
    
    private string SampleInput { get; set; } = @"{
  ""preInvoiceId"": ""PRE-001"",
  ""customer"": {
    ""fullName"": ""John Doe"",
    ""code"": ""CUST001""
  },
  ""amount"": 1500.50,
  ""items"": [
    { ""name"": ""Product A"", ""quantity"": 2 }
  ]
}";

    private string PreviewOutput { get; set; } = string.Empty;
    private string ErrorMessage { get; set; } = string.Empty;

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(MappingJson))
        {
            MappingJson = @"{
  ""invoiceId"": ""{{previousResult.preInvoiceId}}"",
  ""customerName"": ""{{previousResult.customer.fullName}}"",
  ""totalAmount"": ""{{previousResult.amount}}"",
  ""amountAsString"": ""{{toString(previousResult.amount)}}"",
  ""processedAt"": ""{{dateNow()}}"",
  ""buyer"": {
    ""name"": ""{{previousResult.customer.fullName}}"",
    ""code"": ""{{previousResult.customer.code}}""
  }
}";
        }
        UpdatePreview();
    }

    private async Task OnMappingChanged(ChangeEventArgs e)
    {
        MappingJson = e.Value?.ToString() ?? string.Empty;
        await MappingJsonChanged.InvokeAsync(MappingJson);
        UpdatePreview();
    }

    private void OnSampleInputChanged(ChangeEventArgs e)
    {
        SampleInput = e.Value?.ToString() ?? string.Empty;
        UpdatePreview();
    }

    private void UpdatePreview()
    {
        try
        {
            ErrorMessage = string.Empty;
            
            if (string.IsNullOrWhiteSpace(MappingJson) || string.IsNullOrWhiteSpace(SampleInput))
            {
                PreviewOutput = string.Empty;
                return;
            }

            // Parse sample input
            var sampleData = JsonConvert.DeserializeObject(SampleInput);
            
            // Create context
            var context = new Dictionary<string, object?>
            {
                ["previousResult"] = sampleData
            };

            // Apply simple template replacement for preview
            var result = ApplySimpleMapping(MappingJson, context);
            PreviewOutput = JsonConvert.SerializeObject(result, Formatting.Indented);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
            PreviewOutput = string.Empty;
        }
    }

    private object? ApplySimpleMapping(string mappingJson, Dictionary<string, object?> context)
    {
        // Simple template replacement for preview purposes
        // In real implementation, this would use the MappingService
        
        var processed = mappingJson;
        
        // Replace simple template expressions
        processed = System.Text.RegularExpressions.Regex.Replace(processed, 
            @"\{\{previousResult\.([^}]+)\}\}", 
            match => {
                var path = match.Groups[1].Value;
                var value = GetValueFromPath(context["previousResult"], path);
                return JsonConvert.SerializeObject(value);
            });
            
        // Replace functions
        processed = System.Text.RegularExpressions.Regex.Replace(processed,
            @"\{\{toString\(([^)]+)\)\}\}",
            match => {
                var expr = match.Groups[1].Value;
                if (expr.StartsWith("previousResult."))
                {
                    var path = expr.Substring("previousResult.".Length);
                    var value = GetValueFromPath(context["previousResult"], path);
                    return $"\"{value}\"";
                }
                return "\"\"";
            });
            
        processed = System.Text.RegularExpressions.Regex.Replace(processed,
            @"\{\{dateNow\(\)\}\}",
            match => $"\"{DateTime.UtcNow:yyyy-MM-ddTHH:mm:ssZ}\"");

        return JsonConvert.DeserializeObject(processed);
    }

    private object? GetValueFromPath(object? obj, string path)
    {
        if (obj == null) return null;
        
        var parts = path.Split('.');
        var current = obj;
        
        foreach (var part in parts)
        {
            if (current == null) break;
            
            if (current is Newtonsoft.Json.Linq.JObject jobj)
            {
                current = jobj[part]?.ToObject<object>();
            }
            else
            {
                var property = current.GetType().GetProperty(part);
                current = property?.GetValue(current);
            }
        }
        
        return current;
    }
}